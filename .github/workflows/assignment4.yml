name: assignment4

on:
  push:
    branches: ['main']

jobs:
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Record workflow start time
        id: start_time
        run: |
          START_TIME=$(date -Iminutes)
          echo "start_time=$START_TIME" >> $GITHUB_OUTPUT
          echo "$START_TIME" > log.txt
          echo "Gilad Shmuel, Yam Levin" >> log.txt
      
      - name: Build pet-store and pet-order images
        id: build_images
        run: |
          STORE_FAILED=false
          ORDER_FAILED=false
          
          # Build pet-store
          if docker build -t pet-store:latest ./pet-store; then
            echo -n "image pet-store successfully built; " >> log.txt
          else
            echo -n "image pet-store not able to be built; " >> log.txt
            STORE_FAILED=true
          fi
          
          # Build pet-order
          if docker build -t pet-order:latest ./pet-order; then
            echo "image pet-order successfully built;" >> log.txt
          else
            echo "image pet-order not able to be built;" >> log.txt
            ORDER_FAILED=true
          fi
          
          # Fail if either build failed
          if [ "$STORE_FAILED" = true ] || [ "$ORDER_FAILED" = true ]; then
            exit 1
          fi
      
      - name: Save Docker images
        run: |
          docker save pet-store:latest -o pet-store.tar
          docker save pet-order:latest -o pet-order.tar
      
      - name: Upload pet-store image
        uses: actions/upload-artifact@v4
        with:
          name: pet-store-image
          path: pet-store.tar
          retention-days: 1
      
      - name: Upload pet-order image
        uses: actions/upload-artifact@v4
        with:
          name: pet-order-image
          path: pet-order.tar
          retention-days: 1
      
      - name: Save log for next job
        uses: actions/upload-artifact@v4
        with:
          name: log-build
          path: log.txt
          retention-days: 1

  test:
    name: Run Pytest Tests
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download pet-store image
        uses: actions/download-artifact@v4
        with:
          name: pet-store-image
      
      - name: Download pet-order image
        uses: actions/download-artifact@v4
        with:
          name: pet-order-image
      
      - name: Download log from build
        uses: actions/download-artifact@v4
        with:
          name: log-build
      
      - name: Load Docker images
        run: |
          docker load -i pet-store.tar
          docker load -i pet-order.tar
      
      - name: Create Docker network
        run: docker network create petstore-network
      
      - name: Start MongoDB for pet-stores
        run: |
          docker run -d \
            --name mongo-petstore \
            --network petstore-network \
            -p 27017:27017 \
            mongo:latest
      
      - name: Start MongoDB for pet-orders
        run: |
          docker run -d \
            --name mongo-petorder \
            --network petstore-network \
            -p 27018:27017 \
            mongo:latest
      
      - name: Wait for MongoDB to be ready
        run: |
          echo "Waiting for MongoDB instances to be ready..."
          sleep 10
      
      - name: Start all containers
        id: start_containers
        run: |
          STORE1_FAILED=false
          STORE2_FAILED=false
          ORDER_FAILED=false
          
          # Start pet-store #1
          if docker run -d \
            --name pet-store1 \
            --network petstore-network \
            -p 5001:8000 \
            -e MONGO_HOST=mongo-petstore \
            -e MONGO_PORT=27017 \
            -e STORE_ID=1 \
            pet-store:latest; then
            echo -n "Container pet-store #1 up and running; " >> log.txt
          else
            echo -n "Container pet-store #1 failed to run; " >> log.txt
            STORE1_FAILED=true
          fi
          
          # Start pet-store #2
          if docker run -d \
            --name pet-store2 \
            --network petstore-network \
            -p 5002:8000 \
            -e MONGO_HOST=mongo-petstore \
            -e MONGO_PORT=27017 \
            -e STORE_ID=2 \
            pet-store:latest; then
            echo -n "Container pet-store #2 up and running; " >> log.txt
          else
            echo -n "Container pet-store #2 failed to run; " >> log.txt
            STORE2_FAILED=true
          fi
          
          # Start pet-order
          if docker run -d \
            --name pet-order \
            --network petstore-network \
            -p 5003:8080 \
            -e MONGO_HOST=mongo-petorder \
            -e MONGO_PORT=27017 \
            pet-order:latest; then
            echo "Container pet-order up and running;" >> log.txt
          else
            echo "Container pet-order failed to run;" >> log.txt
            ORDER_FAILED=true
          fi
          
          # Fail if any container failed to start
          if [ "$STORE1_FAILED" = true ] || [ "$STORE2_FAILED" = true ] || [ "$ORDER_FAILED" = true ]; then
            exit 1
          fi
      
      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to be ready..."
          sleep 15
          
          # Check if services are responding
          curl -f http://localhost:5001/pet-types || true
          curl -f http://localhost:5002/pet-types || true
          sleep 5
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install pytest and dependencies
        run: |
          pip install pytest requests
      
      - name: Run pytest tests
        id: run_tests
        continue-on-error: true
        run: |
          pytest -v tests/assn4_tests.py > assn4_test_results.txt 2>&1
          if [ $? -eq 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "All pytests succeeded" >> log.txt
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "pytests failed" >> log.txt
          fi
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: assn4_test_results.txt
          retention-days: 90
      
      - name: Save log for next job
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: log-test
          path: log.txt
          retention-days: 1
      
      - name: Check if tests passed
        if: steps.run_tests.outputs.success != 'true'
        run: exit 1
      
      - name: Cleanup containers
        if: always()
        run: |
          docker stop pet-store1 pet-store2 pet-order mongo-petstore mongo-petorder || true
          docker rm pet-store1 pet-store2 pet-order mongo-petstore mongo-petorder || true

  query:
    name: Execute Query Job
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download pet-store image
        uses: actions/download-artifact@v4
        with:
          name: pet-store-image
      
      - name: Download pet-order image
        uses: actions/download-artifact@v4
        with:
          name: pet-order-image
      
      - name: Download log from test
        uses: actions/download-artifact@v4
        with:
          name: log
      
      - name: Load Docker images
        run: |
          docker load -i pet-store.tar
          docker load -i pet-order.tar
      
      - name: Create Docker network
        run: docker network create petstore-network
      
      - name: Start MongoDB for pet-stores
        run: |
          docker run -d \
            --name mongo-petstore \
            --network petstore-network \
            -p 27017:27017 \
            mongo:latest
      
      - name: Start MongoDB for pet-orders
        run: |
          docker run -d \
            --name mongo-petorder \
            --network petstore-network \
            -p 27018:27017 \
            mongo:latest
      
      - name: Wait for MongoDB to be ready
        run: |
          echo "Waiting for MongoDB instances to be ready..."
          sleep 10
      
      - name: Start pet-store #1
        run: |
          docker run -d \
            --name pet-store1 \
            --network petstore-network \
            -p 5001:8000 \
            -e MONGO_HOST=mongo-petstore \
            -e MONGO_PORT=27017 \
            -e STORE_ID=1 \
            pet-store:latest
      
      - name: Start pet-store #2
        run: |
          docker run -d \
            --name pet-store2 \
            --network petstore-network \
            -p 5002:8000 \
            -e MONGO_HOST=mongo-petstore \
            -e MONGO_PORT=27017 \
            -e STORE_ID=2 \
            pet-store:latest
      
      - name: Start pet-order
        run: |
          docker run -d \
            --name pet-order \
            --network petstore-network \
            -p 5003:8080 \
            -e MONGO_HOST=mongo-petorder \
            -e MONGO_PORT=27017 \
            pet-order:latest
      
      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to be ready..."
          sleep 15
          curl -f http://localhost:5001/pet-types || true
          curl -f http://localhost:5002/pet-types || true
          sleep 5
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests
      
      - name: Populate database with test data
        run: |
          python tests/populate_data.py
      
      - name: Execute queries from query.txt
        run: |
          python tests/execute_queries.py
      
      - name: Upload response file
        uses: actions/upload-artifact@v4
        with:
          name: query-response
          path: response.txt
          retention-days: 90
      
      - name: Upload final log file
        uses: actions/upload-artifact@v4
        with:
          name: log-final
          path: log.txt
          retention-days: 90
      
      - name: Cleanup containers
        if: always()
        run: |
          docker stop pet-store1 pet-store2 pet-order mongo-petstore mongo-petorder || true
          docker rm pet-store1 pet-store2 pet-order mongo-petstore mongo-petorder || true

